<?xml version="1.0"?>

<build
	name="ghoghnoos"
	type="live"
	subject="base"
	stage="01"
	username="root"
	password="123"
	in-chroot="yes"
	arch="x86_64"
	version="0.0.2"
	codename="robin"
	timezone="Asia/Tehran">
	
	<phase seq="2" comment="Root file system">
	
		<entry type="script/bash" seq="1" cdto="no" download="no" extract="no">
			<action when="after" seq="1">
				<line>mkdir -v -p $PROJECT__RFS/bin</line>
				<line>mkdir -v -p $PROJECT__RFS/sbin</line>
				<line>mkdir -v -p $PROJECT__RFS/proc</line>
				<line>mkdir -v -p $PROJECT__RFS/usr</line>
				<line>mkdir -v -p $PROJECT__RFS/boot</line>
				<line>mkdir -v -p $PROJECT__RFS/dev</line>
				<line>mkdir -v -p $PROJECT__RFS/etc/profile.d</line>
				<line>mkdir -v -p $PROJECT__RFS/lib</line>
				<line>mkdir -v -p $PROJECT__RFS/srv</line>
				<line>mkdir -v -p $PROJECT__RFS/var</line>
				<line>mkdir -v -p $PROJECT__RFS/proc</line>
				<line>mkdir -v -p $PROJECT__RFS/run</line>
				<line>mkdir -v -p $PROJECT__RFS/root</line>
				<line>mkdir -v -p $PROJECT__RFS/home</line>
				<line>mkdir -v -p $PROJECT__RFS/sys</line>
				<line>mkdir -v -p $PROJECT__RFS/mnt</line>
				<line>mkdir -v -p $PROJECT__RFS/media</line>
				<line>mkdir -v -p $PROJECT__RFS/opt</line>
				<line>mkdir -v -p $PROJECT__RFS/tmp</line>
				
				<line>
					#if [[ "$(uname -m)" == "x86_64" ]]; then
					#	mkdir -v -p $PROJECT__RFS/lib64
					#else
					    ln -s ./lib $PROJECT__RFS/lib64
					#fi
				</line>
				
				<line>chmod 1777 $PROJECT__RFS/tmp</line>
				
				<line>
					cat > $PROJECT__RFS/etc/bootscript.sh &lt;&lt;-EOF
					#!/bin/sh
					
					dmesg -n 1
					mount -t devtmpfs none /dev
					mount -t proc none /proc
					mount -t sysfs none /sys

					for DEVICE in /sys/class/net/* ; do
					    ip link set \${DEVICE##*/} up
					    [ \${DEVICE##*/} != lo ] &amp;&amp; udhcpc -b -i \${DEVICE##*/} -s /etc/rc.dhcp
					done
					
					EOF
				</line>
				<line>chmod +x $PROJECT__RFS/etc/bootscript.sh</line>

				<line>
					cat > $PROJECT__RFS/etc/rc.dhcp &lt;&lt;-EOF
					#!/bin/sh

					ip addr add \$ip/\$mask dev \$interface

					if [ "\$router" ]; then
					    ip route add default via \$router dev \$interface
					fi

					EOF
				</line>
				<line>chmod +x $PROJECT__RFS/etc/rc.dhcp</line>
				
				<line>
					cat > $PROJECT__RFS/etc/resolv.conf &lt;&lt;-EOF
					nameserver 8.8.8.8
					nameserver 8.8.4.4

					EOF
				</line>
				<line>
					cat > $PROJECT__RFS/etc/welcome.txt &lt;&lt;-EOF
					##############################################################
					Welcome to $PROJECT__NAME-$PROJECT__VERSION ($PROJECT__ARCH)

					Author: 
					    $PROJECT__AUTHOR_NAME
					    $PROJECT__AUTHOR_EMAIL

					Website:
					    $PROJECT__WEBSITE
					##############################################################

					EOF
				</line>

				<line>
					cat > $PROJECT__RFS/etc/inittab &lt;&lt;-EOF
					::sysinit:/etc/bootscript.sh
					::restart:/sbin/init
					::ctrlaltdel:/sbin/reboot
					::once:cat /etc/welcome.txt
					::respawn:/bin/cttyhack /bin/sh
					tty2::once:cat /etc/welcome.txt
					tty2::respawn:/bin/sh
					tty3::once:cat /etc/welcome.txt
					tty3::respawn:/bin/sh
					tty4::once:cat /etc/welcome.txt
					tty4::respawn:/bin/sh

					EOF
				</line>

				<line>
					cat > $PROJECT__RFS/etc/passwd &lt;&lt;-EOF
					root:x:0:0:root:/root:/bin/sh
					bin:x:1:1:bin:/dev/null:/bin/false
					daemon:x:6:6:Daemon User:/dev/null:/bin/false
					messagebus:x:18:18:D-Bus Message Daemon User:/var/run/dbus:/bin/false
					nobody:x:99:99:Unprivileged User:/dev/null:/bin/false

					EOF
				</line>

				<line>
					cat > $PROJECT__RFS/etc/group &lt;&lt;-EOF
					root:x:0:
					bin:x:1:daemon
					sys:x:2:
					kmem:x:3:
					tape:x:4:
					tty:x:5:
					daemon:x:6:
					floppy:x:7:
					disk:x:8:
					lp:x:9:
					dialout:x:10:
					audio:x:11:
					video:x:12:
					utmp:x:13:
					usb:x:14:
					cdrom:x:15:
					adm:x:16:
					messagebus:x:18:
					systemd-journal:x:23:
					input:x:24:
					mail:x:34:
					nogroup:x:99:
					users:x:999:

					EOF
				</line>

				<line>
					cat > $PROJECT__RFS/etc/hostname &lt;&lt;-EOF
					$PROJECT__HOSTNAME

					EOF
				</line>

				<line>
					cat > $PROJECT__RFS/etc/hosts &lt;&lt;-EOF
					127.0.0.1 localhost
					127.0.0.1 $PROJECT__HOSTNAME

					EOF
				</line>

				<line>
					cat > $PROJECT__RFS/root/.bash_profile &lt;&lt;-EOF
					exec env -i HOME=/root TERM=$TERM PS1="\e[31m$(whoami)@$(hostname):$(pwd)\$ \e[39m" /bin/sh

					EOF
				</line>

				<line>
					cat > $PROJECT__RFS/root/.bashrc &lt;&lt;-EOF
					export PS1="\e[31m$(whoami)@$(hostname):$(pwd)\$ \e[39m"
					export PATH=/usr/bin:/usr/sbin:/bin:/sbin

					EOF
				</line>

				<line>
					cat > $PROJECT__RFS/init &lt;&lt;-EOF
					#!/bin/sh

					exec /sbin/init

					EOF
				</line>
				<line>chmod +x $PROJECT__RFS/init</line>
			</action>
		</entry>
		
	</phase>
	
</build>

